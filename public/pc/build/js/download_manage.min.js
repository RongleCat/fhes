'use strict';

var fileTypes = ['othe', 'zip', 'avi', 'swf', 'wav', 'txt', 'rmvb', 'xls', 'mkv', 'psd', 'exe', 'gif', 'pdf', 'mp4', 'ppt', 'png', 'mp3', 'jpg', 'doc'];
$(function () {
    var table = layui.table;
    var options = {
        url: '/manage/getDownFileList',
        elem: '#demo',
        id: 'demo',
        page: {
            curr: 1 //重新从第 1 页开始
        },
        limit: 10,
        limits: [10, 15, 20],
        height: 'full-200',
        where: {},
        cols: [[{
            field: 'id',
            title: 'ID',
            width: 80
        }, {
            field: 'title',
            title: '中文标题'
        }, {
            field: 'entitle',
            title: '英文标题'
        }, {
            field: 'size',
            title: '文件大小'
        }, {
            field: 'type',
            title: '文件类型'
        }, {
            fixed: 'right',
            align: 'center',
            title: '操作',
            width: 180,
            field: 'filepath',
            templet: function templet(d) {
                return '<a class="layui-btn layui-btn-primary layui-btn-xs" href="' + d.filepath + '?attname=" download>\u4E0B\u8F7D</a>\n                    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">\u5220\u9664</a>';
            }
        }]]
    };
    var DownloadList = table.render(options);

    $('#btn-search').on('click', function (e) {
        var keyword = $('#ipt-keyword').val();
        options.where.keyword = keyword;
        DownloadList.reload(options);
    });

    $('#btn-clear').on('click', function (e) {
        delete options.where.keyword;
        $('#ipt-keyword').val('');
        DownloadList.reload(options);
    });

    $('#ipt-keyword').on('keypress', function (e) {
        if (e.keyCode === 13) {
            $('#btn-search').click();
        }
    });

    table.on('tool(demo)', function (obj) {
        //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
        var data = obj.data; //获得当前行数据
        var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
        var tr = obj.tr; //获得当前行 tr 的DOM对象
        if (layEvent === 'del') {
            //删除
            layer.confirm('真的要删除这个文件吗？', function (index) {
                // obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                layer.close(index);
                $.ajax({
                    type: "POST",
                    url: "/manage/deleteDownFile",
                    dataType: "json",
                    data: {
                        id: data.id,
                        filepath: data.filepath
                    },
                    success: function success(data) {
                        if (data.ok === 200) {
                            obj.del();
                        } else {
                            layer.msg(data.msg, function () {});
                        }
                    }
                });
            });
        } else {
            $.ajax({
                type: "GET",
                url: "/manage/downFile",
                dataType: "json",
                data: {
                    id: data.id
                },
                success: function success(res) {
                    console.log(res);
                }
            });
        }
    });

    layui.use('layer', function () {
        var layer = layui.layer;
        $('#btn-addfile').on('click', function () {
            var index = layer.open({
                type: 1,
                area: '500px',
                content: '<div class="addfile-container">\n                <form class="layui-form layui-form-pane">\n                    <div class="layui-form-item">\n                        <label class="layui-form-label">\u4E2D\u6587\u6807\u9898</label>\n                        <div class="layui-input-block">\n                            <input type="text" name="title" lay-verify="" placeholder="\u8BF7\u8F93\u5165\u4E2D\u6587\u6807\u9898" autocomplete="off" class="layui-input">\n                        </div>\n                    </div>\n                    <div class="layui-form-item">\n                        <label class="layui-form-label">\u82F1\u6587\u6807\u9898</label>\n                        <div class="layui-input-block">\n                            <input type="text" name="entitle" lay-verify="" placeholder="\u8BF7\u8F93\u5165\u82F1\u6587\u6807\u9898" autocomplete="off" class="layui-input">\n                        </div>\n                    </div>\n                    <div class="layui-form-item">\n                        <label class="layui-form-label upload-file">\u9009\u62E9\u6587\u4EF6</label>\n                        <div class="layui-input-block cover">\n                            <div class="layui-upload-drag" id="upload-file">\n                                <i class="layui-icon">\uE67C</i>\n                                <p>\u70B9\u51FB\u4E0A\u4F20\uFF0C\u6216\u5C06\u6587\u4EF6\u62D6\u62FD\u5230\u6B64\u5904</p>\n                                <span></span>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="layui-form-item btn-box">\n                        <button class="layui-btn" lay-submit lay-filter="submit" id="btn-submit">\u7ACB\u5373\u63D0\u4EA4</button>\n                    </div>\n                </form>\n            </div>',
                success: function success(el, index) {
                    //初始化上传
                    var upload = layui.upload;
                    var post = {};

                    var uploader = Qiniu.uploader({
                        runtimes: 'html5,flash,html4', //上传模式,依次退化
                        browse_button: 'upload-file',
                        uptoken_url: '/manage/uptoken?type=file',
                        domain: 'http://p9gz545fl.bkt.clouddn.com/',
                        max_file_size: '100mb', //最大文件体积限制
                        max_retries: 3, //上传失败最大重试次数
                        dragdrop: true, //开启可拖曳上传
                        chunk_size: '4mb', //分块上传时，每片的体积
                        auto_start: true, //选择文件后自动上传，若关闭需要自己绑定事件触发上传
                        init: {
                            'UploadProgress': function UploadProgress(up, file) {
                                var $tip = $('#upload-file').find('span');
                                $tip.text('已上传 ' + uploader.total.percent + '%');
                            },
                            'FileUploaded': function FileUploaded(up, file, info) {
                                var domain = up.getOption('domain');
                                var res = $.parseJSON(info);
                                var sourceLink = domain + res.key;
                                var fileType = getFileType(res.key);

                                if (fileTypes.indexOf(fileType) > -1) {
                                    post.type = fileType;
                                } else {
                                    if (fileType === 'xlsx' || fileType === 'pptx' || fileType === 'docx') {
                                        post.type = fileType.substring(0, 3);
                                    } else {
                                        post.type = 'othe';
                                    }
                                }
                                post.size = bytesToSize(file.size);
                                post.filepath = sourceLink;
                                $('#upload-file').find('span').text('\u5DF2\u4E0A\u4F20 ' + res.key);
                            },
                            'Error': function Error(up, err, errTip) {
                                //上传出错时,处理相关的事情
                                printLog('on Error');
                            }
                        }
                    });

                    layui.use('form', function () {
                        var form = layui.form;
                        form.on('submit(submit)', function (data) {
                            console.log(data);
                            if (!$.trim(data.field.title)) {
                                layer.msg('中文标题不能为空', function () {});
                                return false;
                            }
                            if (!$.trim(data.field.entitle)) {
                                layer.msg('英文标题不能为空', function () {});
                                return false;
                            }
                            post.title = data.field.title;
                            post.entitle = data.field.entitle;
                            if (!(post.filepath && post.size && post.type)) {
                                layer.msg('请上传文件！', function () {});
                                return false;
                            }

                            console.log(post);
                            $.ajax({
                                type: "POST",
                                url: "/manage/addDownFile",
                                dataType: "json",
                                data: post,
                                success: function success(data) {
                                    if (data.ok === 200) {
                                        // targetParent('DownloadList')
                                        location.reload();
                                    } else {
                                        layer.msg(data.msg);
                                    }
                                }
                            });
                            return false;
                        });
                    });
                    el.on('click', '#btn-submit', function () {
                        console.log(111);
                    });
                }
            });
        });
    });
});

//获取后缀名
function getFileType(name) {
    var dotindex = name.lastIndexOf('.');
    return name.substring(dotindex + 1, name.length);
}

//转换文件大小
function bytesToSize(bytes) {
    if (bytes === 0) return '0 B';
    var k = 1024,
        // or 1024
    sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
        i = Math.floor(Math.log(bytes) / Math.log(k));

    return (bytes / Math.pow(k, i)).toPrecision(3) + sizes[i];
}