"use strict";var fileTypes=["othe","zip","avi","swf","wav","txt","rmvb","xls","mkv","psd","exe","gif","pdf","mp4","ppt","png","mp3","jpg","doc"];function getFileType(e){var i=e.lastIndexOf(".");return e.substring(i+1,e.length)}function bytesToSize(e){if(0===e)return"0 B";var i=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,i)).toPrecision(3)+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][i]}$(function(){var e=layui.table,t={url:"/manage/getDownFileList",elem:"#demo",id:"demo",page:{curr:1},limit:10,limits:[10,15,20],height:"full-200",where:{},cols:[[{field:"id",title:"ID",width:80},{field:"title",title:"中文标题"},{field:"entitle",title:"英文标题"},{field:"size",title:"文件大小"},{field:"type",title:"文件类型"},{fixed:"right",align:"center",title:"操作",width:180,field:"filepath",templet:function(e){return'<a class="layui-btn layui-btn-primary layui-btn-xs" href="'+e.filepath+'?attname=" download>下载</a>\n                    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>'}}]]},l=e.render(t);$("#btn-search").on("click",function(e){var i=$("#ipt-keyword").val();t.where.keyword=i,l.reload(t)}),$("#btn-clear").on("click",function(e){delete t.where.keyword,$("#ipt-keyword").val(""),l.reload(t)}),$("#ipt-keyword").on("keypress",function(e){13===e.keyCode&&$("#btn-search").click()}),e.on("tool(demo)",function(i){var t=i.data,e=i.event;i.tr;"del"===e?layer.confirm("真的要删除这个文件吗？",function(e){layer.close(e),$.ajax({type:"POST",url:"/manage/deleteDownFile",dataType:"json",data:{id:t.id,filepath:t.filepath},success:function(e){200===e.ok?i.del():layer.msg(e.msg,function(){})}})}):$.ajax({type:"GET",url:"/manage/downFile",dataType:"json",data:{id:t.id},success:function(e){console.log(e)}})}),layui.use("layer",function(){var l=layui.layer;$("#btn-addfile").on("click",function(){l.open({type:1,area:"500px",content:'<div class="addfile-container">\n                <form class="layui-form layui-form-pane">\n                    <div class="layui-form-item">\n                        <label class="layui-form-label">中文标题</label>\n                        <div class="layui-input-block">\n                            <input type="text" name="title" lay-verify="" placeholder="请输入中文标题" autocomplete="off" class="layui-input">\n                        </div>\n                    </div>\n                    <div class="layui-form-item">\n                        <label class="layui-form-label">英文标题</label>\n                        <div class="layui-input-block">\n                            <input type="text" name="entitle" lay-verify="" placeholder="请输入英文标题" autocomplete="off" class="layui-input">\n                        </div>\n                    </div>\n                    <div class="layui-form-item">\n                        <label class="layui-form-label upload-file">选择文件</label>\n                        <div class="layui-input-block cover">\n                            <div class="layui-upload-drag" id="upload-file">\n                                <i class="layui-icon"></i>\n                                <p>点击上传，或将文件拖拽到此处</p>\n                                <span></span>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="layui-form-item btn-box">\n                        <button class="layui-btn" lay-submit lay-filter="submit" id="btn-submit">立即提交</button>\n                    </div>\n                </form>\n            </div>',success:function(e,i){layui.upload;var s={},t=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"upload-file",uptoken_url:"/manage/uptoken?type=file",domain:"http://p9gz545fl.bkt.clouddn.com/",max_file_size:"100mb",max_retries:3,dragdrop:!0,chunk_size:"4mb",auto_start:!0,init:{UploadProgress:function(e,i){$("#upload-file").find("span").text("已上传 "+t.total.percent+"%")},FileUploaded:function(e,i,t){var l=e.getOption("domain"),n=$.parseJSON(t),a=l+n.key,o=getFileType(n.key);-1<fileTypes.indexOf(o)?s.type=o:s.type="xlsx"===o||"pptx"===o||"docx"===o?o.substring(0,3):"othe",s.size=bytesToSize(i.size),s.filepath=a,$("#upload-file").find("span").text("已上传 "+n.key)},Error:function(e,i,t){printLog("on Error")}}});layui.use("form",function(){layui.form.on("submit(submit)",function(e){return console.log(e),$.trim(e.field.title)?$.trim(e.field.entitle)?(s.title=e.field.title,s.entitle=e.field.entitle,s.filepath&&s.size&&s.type?(console.log(s),$.ajax({type:"POST",url:"/manage/addDownFile",dataType:"json",data:s,success:function(e){200===e.ok?location.reload():l.msg(e.msg)}})):l.msg("请上传文件！",function(){}),!1):(l.msg("英文标题不能为空",function(){}),!1):(l.msg("中文标题不能为空",function(){}),!1)})}),e.on("click","#btn-submit",function(){console.log(111)})}})})})});