'use strict';

var fileTypes = ['othe', 'zip', 'avi', 'swf', 'wav', 'txt', 'rmvb', 'xls', 'mkv', 'psd', 'exe', 'gif', 'pdf', 'mp4', 'ppt', 'png', 'mp3', 'jpg', 'doc'];
$(function () {
  var table = layui.table;
  var options = {
    url: '/manage/getProductList',
    elem: '#demo',
    id: 'demo',
    page: {
      curr: 1 //重新从第 1 页开始
    },
    limit: 10,
    limits: [10, 15, 20],
    height: 'full-200',
    where: {},
    cols: [[{
      field: 'id',
      title: 'ID',
      width: 80
    }, {
      field: 'cover',
      title: '封面图片',
      width: 130,
      templet: function templet(d) {
        return '<img src="' + d.cover + '">';
      }
    }, {
      field: 'title',
      title: '中文标题'
    }, {
      field: 'entitle',
      title: '英文标题'
    }, {
      field: 'classname',
      title: '所属分类'
    }, {
      fixed: 'right',
      align: 'center',
      title: '操作',
      width: 180,
      field: 'filepath',
      templet: function templet(d) {
        return '<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">\u67E5\u770B</a>\n          <a class="layui-btn layui-btn-xs" lay-event="edit">\u7F16\u8F91</a>\n          <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">\u5220\u9664</a>';
      }
    }]]
  };
  var DownloadList = table.render(options);

  $('#btn-search').on('click', function (e) {
    var keyword = $('#ipt-keyword').val();
    options.where.keyword = keyword;
    DownloadList.reload(options);
  });

  $('#btn-clear').on('click', function (e) {
    delete options.where.keyword;
    $('#ipt-keyword').val('');
    DownloadList.reload(options);
  });

  $('#ipt-keyword').on('keypress', function (e) {
    if (e.keyCode === 13) {
      $('#btn-search').click();
    }
  });

  layui.use('form', function () {
    var form = layui.form;
    form.on('select(class)', function (data) {
      options.where.classid = data.value;
      DownloadList.reload(options);
    });
  });

  table.on('tool(demo)', function (obj) {
    //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
    var $data = obj.data; //获得当前行数据
    var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
    var tr = obj.tr; //获得当前行 tr 的DOM对象
    if (layEvent === 'del') {
      //删除
      layer.confirm('真的要删除这个产品吗？', function (index) {
        // obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
        layer.close(index);
        $.ajax({
          type: "POST",
          url: "/manage/deleteproduc",
          dataType: "json",
          data: {
            id: $data.id
          },
          success: function success(r) {
            if (r.ok === 200) {
              obj.del();
            } else {
              layer.msg(r.msg, function () {});
            }
          }
        });
      });
    } else if (layEvent == 'detail') {
      console.log('查看');
    } else {
      location.href = '/manage/editeroduct/' + $data.id;
    }
  });
});

$('#btn-addfile').on('click', function () {
  location.href = '/manage/adderoduct';
});